<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Alagamentos SP</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 20px;
            padding-bottom: 40px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .header {
            margin-bottom: 20px;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .table {
            margin-top: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .status-0 {
            background-color: #d4edda;
        }
        .status-1 {
            background-color: #fff3cd;
        }
        .status-2 {
            background-color: #ffe5d0;
        }
        .status-3plus {
            background-color: #f8d7da;
        }
        .bot-info {
            margin: 30px 0;
            padding: 20px;
            background-color: #e9ecef;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .update-time {
            font-size: 0.8rem;
            font-style: italic;
            margin-top: 5px;
        }
        #error-message {
            display: none;
            margin-top: 20px;
        }
        .loading-spinner {
            text-align: center;
            margin: 40px 0;
        }
        .dashboard-summary {
            margin-bottom: 20px;
        }
        .summary-card {
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .summary-card:hover {
            transform: translateY(-5px);
        }
        .point-details {
            background-color: #f8f9fa;
            border-left: 4px solid #ccc;
            padding: 10px;
            margin-top: 5px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .point-address {
            font-weight: 500;
        }
        .water-level {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .level-baixo {
            background-color: #cfe2ff;
            color: #084298;
        }
        .level-medio {
            background-color: #fff3cd;
            color: #856404;
        }
        .level-alto {
            background-color: #f8d7da;
            color: #721c24;
        }
        .level-intransitavel {
            background-color: #842029;
            color: white;
        }
        #filter-options {
            margin-bottom: 20px;
        }
        .region-heading {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .region-details {
            margin-top: 10px;
        }
        footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .transport-info {
            margin-top: 5px;
            font-style: italic;
            color: #495057;
        }
        .stats-card {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            height: 100%;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .stats-card h2 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        .stats-card p {
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header text-center">
            <h1><i class="fas fa-water text-primary me-2"></i>Monitor de Alagamentos São Paulo</h1>
            <p class="lead">Monitoramento em tempo real dos pontos de alagamento com detalhes</p>
            <div class="update-time" id="last-update"></div>
        </div>

        <div class="alert alert-danger" id="error-message" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>Erro ao buscar dados. Tente atualizar a página.
        </div>

        <div class="loading-spinner" id="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p>Carregando dados...</p>
        </div>

        <!-- Cards de estatísticas -->
        <div class="row dashboard-summary" id="stats-dashboard">
            <div class="col-md-3">
                <div class="stats-card bg-light">
                    <h2 id="total-pontos">0</h2>
                    <p>Total de Pontos</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card bg-danger text-white">
                    <h2 id="pontos-criticos">0</h2>
                    <p>Pontos Críticos</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card bg-warning">
                    <h2 id="tempo-medio">0</h2>
                    <p>Média (min)</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card bg-info text-white">
                    <h2 id="regiao-pior">-</h2>
                    <p>Região mais afetada</p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h3 class="mb-0"><i class="fas fa-map-marked-alt me-2"></i>Regiões Monitoradas</h3>
                        <button class="btn btn-light" id="refresh-btn">
                            <i class="fas fa-sync-alt me-2"></i>Atualizar Dados
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Filtros -->
                        <div id="filter-options">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text">Pesquisar</span>
                                        <input type="text" class="form-control" id="search-input" placeholder="Buscar por região ou endereço...">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="btn-group w-100">
                                        <button class="btn btn-outline-secondary filter-btn active" data-filter="all">Todos</button>
                                        <button class="btn btn-outline-success filter-btn" data-filter="0">Sem Alagamentos</button>
                                        <button class="btn btn-outline-warning filter-btn" data-filter="1">Atenção</button>
                                        <button class="btn btn-outline-danger filter-btn" data-filter="critical">Críticos</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tabela principal -->
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover" id="alagamentos-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Região</th>
                                        <th>Pontos</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="alagamentos-body">
                                    <!-- Dados serão inseridos aqui via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detalhes expandidos -->
        <div id="regions-details">
            <!-- Detalhes das regiões serão inseridos aqui -->
        </div>

        <div class="bot-info">
            <h4><i class="fab fa-telegram text-info me-2"></i>Receba atualizações no Telegram</h4>
            <p>Assine nosso canal para receber alertas quando houver alterações nos pontos de alagamento:</p>
            <a href="https://t.me/alagamentos_sp_bot" class="btn btn-info" target="_blank">
                <i class="fab fa-telegram me-2"></i>Assinar Canal no Telegram
            </a>
            <p class="mt-3">
                <small>O bot envia alertas personalizados com base nas regiões que você escolher acompanhar e no nível de severidade dos alagamentos.</small>
            </p>
        </div>

        <footer class="text-center text-muted">
            <p>Dados obtidos do <a href="https://www.cgesp.org/v3/alagamentos.jsp" target="_blank">CGE - Centro de Gerenciamento de Emergências</a> da Prefeitura de São Paulo.</p>
            <p>Este site não possui vínculo com órgãos oficiais e é um projeto independente.</p>
            <p><small>Última atualização do site: 23/03/2025</small></p>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Buscar dados ao carregar a página
            fetchAlagamentosData();
            
            // Configurar o botão de atualização
            document.getElementById('refresh-btn').addEventListener('click', function() {
                fetchAlagamentosData();
            });

            // Configurar filtros
            document.querySelectorAll('.filter-btn').forEach(button => {
                button.addEventListener('click', function() {
                    // Remover classe active de todos os botões
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Adicionar classe active ao botão clicado
                    this.classList.add('active');
                    
                    // Aplicar filtro
                    const filter = this.getAttribute('data-filter');
                    filterTable(filter);
                });
            });

            // Configurar busca
            document.getElementById('search-input').addEventListener('keyup', function() {
                searchTable(this.value);
            });

            // Função para buscar os dados de alagamentos via proxy
            function fetchAlagamentosData() {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error-message').style.display = 'none';
                
                // URL do serviço que fará o scraping e retornará os dados
                // Este é um placeholder - você precisará substituir pelo seu serviço real
                const proxyUrl = 'https://your-serverless-function-url.com/api/alagamentos';
                
                // Para desenvolvimento/demonstração, vamos usar dados estáticos
                // Em produção, descomente a chamada fetch abaixo
                
                setTimeout(() => {
                    // Dados simulados para demonstração com detalhes adicionais
                    const demoData = [
                        {
                            regiao: "ZONA LESTE", 
                            pontos: 2,
                            pontos_detalhes: [
                                {
                                    endereco: "Av. Itaquera x Rua Harry Danhenberg",
                                    bairro: "Itaquera",
                                    inicio: "12:30",
                                    nivel: "medio",
                                    duracao: 45,
                                    transportes: "Desvio pela Rua Augusto Carlos Bauman"
                                },
                                {
                                    endereco: "Av. Aricanduva próximo ao Shopping",
                                    bairro: "Aricanduva",
                                    inicio: "12:45",
                                    nivel: "alto",
                                    duracao: 65,
                                    transportes: "Linhas de ônibus 2706-10 e 2707-10 desviadas"
                                }
                            ]
                        },
                        {
                            regiao: "CENTRO", 
                            pontos: 1,
                            pontos_detalhes: [
                                {
                                    endereco: "Av. Prestes Maia x Túnel do Anhangabaú",
                                    bairro: "República",
                                    inicio: "13:10", 
                                    nivel: "baixo",
                                    duracao: 25,
                                    transportes: "Acesso ao Metrô República com dificuldade"
                                }
                            ]
                        },
                        {
                            regiao: "ZONA NORTE", 
                            pontos: 0,
                            pontos_detalhes: []
                        },
                        {
                            regiao: "ZONA OESTE", 
                            pontos: 3,
                            pontos_detalhes: [
                                {
                                    endereco: "Marginal Pinheiros altura da Ponte Cidade Universitária",
                                    bairro: "Butantã",
                                    inicio: "12:10",
                                    nivel: "intransitavel",
                                    duracao: 90,
                                    transportes: "Desvio pelo Jaguaré, CPTM Linha 9 com operação parcial"
                                },
                                {
                                    endereco: "Av. Corifeu de Azevedo Marques próximo à USP",
                                    bairro: "Butantã",
                                    inicio: "12:15",
                                    nivel: "medio",
                                    duracao: 60,
                                    transportes: "Linhas de ônibus operando com atraso"
                                },
                                {
                                    endereco: "Rua Camargo próximo ao Parque Villa-Lobos",
                                    bairro: "Alto de Pinheiros",
                                    inicio: "12:30",
                                    nivel: "alto",
                                    duracao: 75,
                                    transportes: "Acesso ao Parque Villa-Lobos bloqueado"
                                }
                            ]
                        },
                        {
                            regiao: "ZONA SUL", 
                            pontos: 1,
                            pontos_detalhes: [
                                {
                                    endereco: "Av. Washington Luís próximo ao Aeroporto",
                                    bairro: "Campo Belo",
                                    inicio: "13:00",
                                    nivel: "baixo",
                                    duracao: 30,
                                    transportes: "Acesso ao Aeroporto de Congonhas com lentidão"
                                }
                            ]
                        }
                    ];
                    updateTable(demoData);
                    updateDetailedView(demoData);
                    updateStatistics(demoData);
                    document.getElementById('loading').style.display = 'none';
                }, 1000);
                
                /* Em produção, use este código para buscar dados reais
                fetch(proxyUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Falha na rede ou servidor');
                        }
                        return response.json();
                    })
                    .then(data => {
                        updateTable(data);
                        updateDetailedView(data);
                        updateStatistics(data);
                        document.getElementById('loading').style.display = 'none';
                    })
                    .catch(error => {
                        console.error('Erro ao buscar dados:', error);
                        document.getElementById('error-message').style.display = 'block';
                        document.getElementById('loading').style.display = 'none';
                    });
                */
            }

            // Função para atualizar estatísticas
            function updateStatistics(data) {
                // Calcular total de pontos
                const totalPontos = data.reduce((total, item) => total + item.pontos, 0);
                document.getElementById('total-pontos').textContent = totalPontos;
                
                // Calcular pontos críticos (nível alto ou intransitável)
                let pontosCriticos = 0;
                data.forEach(region => {
                    region.pontos_detalhes.forEach(ponto => {
                        if (ponto.nivel === 'alto' || ponto.nivel === 'intransitavel') {
                            pontosCriticos++;
                        }
                    });
                });
                document.getElementById('pontos-criticos').textContent = pontosCriticos;
                
                // Calcular tempo médio de duração
                let totalDuracao = 0;
                let totalPontosComDuracao = 0;
                
                data.forEach(region => {
                    region.pontos_detalhes.forEach(ponto => {
                        if (ponto.duracao) {
                            totalDuracao += ponto.duracao;
                            totalPontosComDuracao++;
                        }
                    });
                });
                
                const tempoMedio = totalPontosComDuracao > 0 ? Math.round(totalDuracao / totalPontosComDuracao) : 0;
                document.getElementById('tempo-medio').textContent = tempoMedio;
                
                // Determinar região mais afetada
                if (data.length > 0) {
                    const regiaoMaisAfetada = data.reduce((prev, current) => 
                        (prev.pontos > current.pontos) ? prev : current
                    );
                    document.getElementById('regiao-pior').textContent = regiaoMaisAfetada.regiao.split(' ')[1];
                }
            }

            // Função para atualizar a tabela com os dados recebidos
            function updateTable(data) {
                const tableBody = document.getElementById('alagamentos-body');
                tableBody.innerHTML = '';
                
                // Ordenar por número de pontos (decrescente)
                data.sort((a, b) => b.pontos - a.pontos);
                
                data.forEach(item => {
                    const row = document.createElement('tr');
                    
                    // Adicionar classe CSS com base no número de pontos
                    if (item.pontos === 0) {
                        row.className = 'status-0';
                        row.dataset.status = '0';
                    } else if (item.pontos === 1) {
                        row.className = 'status-1';
                        row.dataset.status = '1';
                    } else if (item.pontos === 2) {
                        row.className = 'status-2';
                        row.dataset.status = '2';
                    } else {
                        row.className = 'status-3plus';
                        row.dataset.status = '3plus';
                    }
                    
                    // Adicionar dados da região para filtros
                    row.dataset.region = item.regiao.toLowerCase();
                    
                    // Botão para expandir detalhes
                    const viewDetailsBtn = item.pontos > 0 ? 
                        `<button class="btn btn-sm btn-outline-primary view-details" data-region="${item.regiao}">
                            <i class="fas fa-info-circle"></i> Detalhes
                        </button>` : 
                        `<button class="btn btn-sm btn-outline-secondary" disabled>
                            <i class="fas fa-times-circle"></i> Sem pontos
                        </button>`;
                    
                    row.innerHTML = `
                        <td>${item.regiao}</td>
                        <td><span class="badge bg-${getBadgeColor(item.pontos)}">${item.pontos}</span></td>
                        <td>${getStatusText(item.pontos)}</td>
                        <td>${viewDetailsBtn}</td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Adicionar event listeners para os botões de detalhes
                document.querySelectorAll('.view-details').forEach(button => {
                    button.addEventListener('click', function() {
                        const region = this.getAttribute('data-region');
                        toggleRegionDetails(region);
                    });
                });
                
                // Atualizar horário da última verificação
                const now = new Date();
                document.getElementById('last-update').textContent = 
                    `Última atualização: ${now.toLocaleDateString()} às ${now.toLocaleTimeString()}`;
            }

            // Função para criar a visualização detalhada das regiões
            function updateDetailedView(data) {
                const detailsContainer = document.getElementById('regions-details');
                detailsContainer.innerHTML = '';
                
                data.forEach(region => {
                    if (region.pontos === 0) return; // Pular regiões sem alagamentos
                    
                    const card = document.createElement('div');
                    card.className = 'card mb-3 region-detail-card';
                    card.id = `region-${region.regiao.replace(/\s+/g, '-').toLowerCase()}`;
                    card.style.display = 'none'; // Inicialmente oculto
                    
                    let pontosHTML = '';
                    region.pontos_detalhes.forEach(ponto => {
                        pontosHTML += `
                            <div class="point-details mb-3">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <div class="point-address">${ponto.endereco}</div>
                                        <div class="text-muted">Bairro: ${ponto.bairro}</div>
                                    </div>
                                    <span class="water-level level-${ponto.nivel}">${getNivelText(ponto.nivel)}</span>
                                </div>
                                <div class="mt-2">
                                    <small>
                                        <i class="far fa-clock me-1"></i>Início: ${ponto.inicio} 
                                        (${ponto.duracao} min)
                                    </small>
                                </div>
                                <div class="transport-info">
                                    <i class="fas fa-bus me-1"></i>${ponto.transportes}
                                </div>
                            </div>
                        `;
                    });
                    
                    card.innerHTML = `
                        <div class="card-header ${getHeaderClass(region.pontos)}">
                            <h5 class="mb-0">${region.regiao} - ${region.pontos} ponto(s) de alagamento</h5>
                        </div>
                        <div class="card-body">
                            ${pontosHTML}
                        </div>
                    `;
                    
                    detailsContainer.appendChild(card);
                });
            }
            
            // Função para mostrar/ocultar detalhes da região
            function toggleRegionDetails(region) {
                const regionId = `region-${region.replace(/\s+/g, '-').toLowerCase()}`;
                const card = document.getElementById(regionId);
                
                if (card) {
                    // Alternar visibilidade
                    if (card.style.display === 'none') {
                        card.style.display = 'block';
                        // Rolar até o card
                        card.scrollIntoView({behavior: 'smooth', block: 'start'});
                    } else {
                        card.style.display = 'none';
                    }
                }
            }
            
            // Função para filtrar a tabela
            function filterTable(filter) {
                const rows = document.querySelectorAll('#alagamentos-body tr');
                
                rows.forEach(row => {
                    if (filter === 'all') {
                        row.style.display = '';
                    } else if (filter === 'critical') {
                        row.style.display = (row.dataset.status === '2' || row.dataset.status === '3plus') ? '' : 'none';
                    } else {
                        row.style.display = (row.dataset.status === filter) ? '' : 'none';
                    }
                });
            }
            
            // Função para pesquisar na tabela
            function searchTable(query) {
                const rows = document.querySelectorAll('#alagamentos-body tr');
                query = query.toLowerCase();
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(query) ? '' : 'none';
                });
            }
            
            // Função para retornar texto do status com base no número de pontos
            function getStatusText(pontos) {
                if (pontos === 0) return '<span class="text-success">Sem alagamentos</span>';
                if (pontos === 1) return '<span class="text-warning">Atenção</span>';
                if (pontos === 2) return '<span class="text-orange">Alerta</span>';
                return '<span class="text-danger">Crítico</span>';
            }
            
            // Função para retornar cor do badge
            function getBadgeColor(pontos) {
                if (pontos === 0) return 'success';
                if (pontos === 1) return 'warning';
                if (pontos === 2) return 'warning text-dark';
                return 'danger';
            }
            
            // Função para retornar classe de cabeçalho do card
            function getHeaderClass(pontos) {
                if (pontos === 1) return 'bg-warning text-dark';
                if (pontos === 2) return 'bg-orange text-white';
                return 'bg-danger text-white';
            }
            
            // Função para retornar texto do nível de água
            function getNivelText(nivel) {
                if (nivel === 'baixo') return 'Baixo';
                if (nivel === 'medio') return 'Médio';
                if (nivel === 'alto') return 'Alto';
                return 'Intransitável';
            }
        });