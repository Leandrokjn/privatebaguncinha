<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Alagamentos SP</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 20px;
            padding-bottom: 40px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .header {
            margin-bottom: 20px;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .table {
            margin-top: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .status-0 {
            background-color: #d4edda;
        }
        .status-1 {
            background-color: #fff3cd;
        }
        .status-2 {
            background-color: #ffe5d0;
        }
        .status-3plus {
            background-color: #f8d7da;
        }
        .bot-info {
            margin: 30px 0;
            padding: 20px;
            background-color: #e9ecef;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .update-time {
            font-size: 0.8rem;
            font-style: italic;
            margin-top: 5px;
        }
        #error-message {
            display: none;
            margin-top: 20px;
        }
        .loading-spinner {
            text-align: center;
            margin: 40px 0;
        }
        .dashboard-summary {
            margin-bottom: 20px;
        }
        .summary-card {
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .summary-card:hover {
            transform: translateY(-5px);
        }
        .point-details {
            background-color: #f8f9fa;
            border-left: 4px solid #ccc;
            padding: 10px;
            margin-top: 5px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .point-address {
            font-weight: 500;
        }
        .water-level {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .level-baixo {
            background-color: #cfe2ff;
            color: #084298;
        }
        .level-medio {
            background-color: #fff3cd;
            color: #856404;
        }
        .level-alto {
            background-color: #f8d7da;
            color: #721c24;
        }
        .level-intransitavel {
            background-color: #842029;
            color: white;
        }
        #filter-options {
            margin-bottom: 20px;
        }
        .region-heading {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .region-details {
            margin-top: 10px;
        }
        footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .transport-info {
            margin-top: 5px;
            font-style: italic;
            color: #495057;
        }
        .stats-card {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            height: 100%;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .stats-card h2 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        .stats-card p {
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header text-center">
            <h1><i class="fas fa-water text-primary me-2"></i>Monitor de Alagamentos São Paulo</h1>
            <p class="lead">Monitoramento em tempo real dos pontos de alagamento com detalhes</p>
            <div class="update-time" id="last-update"></div>
        </div>

        <div class="alert alert-danger" id="error-message" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>Erro ao buscar dados. Tente atualizar a página.
        </div>

        <div class="loading-spinner" id="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p>Carregando dados...</p>
        </div>

        <!-- Cards de estatísticas -->
        <div class="row dashboard-summary" id="stats-dashboard">
            <div class="col-md-3">
                <div class="stats-card bg-light">
                    <h2 id="total-pontos">0</h2>
                    <p>Total de Pontos</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card bg-danger text-white">
                    <h2 id="pontos-criticos">0</h2>
                    <p>Pontos Críticos</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card bg-warning">
                    <h2 id="tempo-medio">0</h2>
                    <p>Média (min)</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card bg-info text-white">
                    <h2 id="regiao-pior">-</h2>
                    <p>Região mais afetada</p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h3 class="mb-0"><i class="fas fa-map-marked-alt me-2"></i>Regiões Monitoradas</h3>
                        <button class="btn btn-light" id="refresh-btn">
                            <i class="fas fa-sync-alt me-2"></i>Atualizar Dados
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Filtros -->
                        <div id="filter-options">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text">Pesquisar</span>
                                        <input type="text" class="form-control" id="search-input" placeholder="Buscar por região ou endereço...">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="btn-group w-100">
                                        <button class="btn btn-outline-secondary filter-btn active" data-filter="all">Todos</button>
                                        <button class="btn btn-outline-success filter-btn" data-filter="0">Sem Alagamentos</button>
                                        <button class="btn btn-outline-warning filter-btn" data-filter="1">Atenção</button>
                                        <button class="btn btn-outline-danger filter-btn" data-filter="critical">Críticos</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tabela principal -->
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover" id="alagamentos-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Região</th>
                                        <th>Pontos</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="alagamentos-body">
                                    <!-- Dados serão inseridos aqui via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detalhes expandidos -->
        <div id="regions-details">
            <!-- Detalhes das regiões serão inseridos aqui -->
        </div>

        <div class="bot-info">
            <h4><i class="fab fa-telegram text-info me-2"></i>Receba atualizações no Telegram</h4>
            <p>Assine nosso canal para receber alertas quando houver alterações nos pontos de alagamento:</p>
            <a href="https://t.me/alagamentos_sp_bot" class="btn btn-info" target="_blank">
                <i class="fab fa-telegram me-2"></i>Assinar Canal no Telegram
            </a>
            <p class="mt-3">
                <small>O bot envia alertas personalizados com base nas regiões que você escolher acompanhar e no nível de severidade dos alagamentos.</small>
            </p>
        </div>

        <footer class="text-center text-muted">
            <p>Dados obtidos do <a href="https://www.cgesp.org/v3/alagamentos.jsp" target="_blank">CGE - Centro de Gerenciamento de Emergências</a> da Prefeitura de São Paulo.</p>
            <p>Este site não possui vínculo com órgãos oficiais e é um projeto independente.</p>
            <p><small>Última atualização do site: 23/03/2025</small></p>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // URL do CGE SP
            const CGE_URL = "https://www.cgesp.org/v3/alagamentos.jsp?dataBusca=23%2F03%2F2025&enviaBusca=Buscar";
            
            // Buscar dados ao carregar a página
            fetchAlagamentosData();
            
            // Configurar o botão de atualização
            document.getElementById('refresh-btn').addEventListener('click', function() {
                fetchAlagamentosData();
            });

            // Configurar filtros
            document.querySelectorAll('.filter-btn').forEach(button => {
                button.addEventListener('click', function() {
                    // Remover classe active de todos os botões
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Adicionar classe active ao botão clicado
                    this.classList.add('active');
                    
                    // Aplicar filtro
                    const filter = this.getAttribute('data-filter');
                    filterTable(filter);
                });
            });

            // Configurar busca
            document.getElementById('search-input').addEventListener('keyup', function() {
                searchTable(this.value);
            });

            // Função para buscar os dados de alagamentos
            function fetchAlagamentosData() {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error-message').style.display = 'none';
                
                // Utilizar CORS proxy para acessar o site do CGE
                const corsProxyUrl = "https://corsproxy.io/?";
                const proxyUrl = corsProxyUrl + encodeURIComponent(CGE_URL);
                
                // Buscar dados reais
                fetch(proxyUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Falha na rede ou servidor');
                        }
                        return response.text();
                    })
                    .then(html => {
                        const data = parseAlagamentosData(html);
                        updateTable(data);
                        updateDetailedView(data);
                        updateStatistics(data);
                        document.getElementById('loading').style.display = 'none';
                    })
                    .catch(error => {
                        console.error('Erro ao buscar dados:', error);
                        document.getElementById('error-message').style.display = 'block';
                        document.getElementById('loading').style.display = 'none';
                        
                        // Em caso de erro, usar dados estáticos de demonstração
                        useDemoData();
                    });
            }
            
            // Parser para extrair dados do HTML do CGE
            function parseAlagamentosData(html) {
                // Criar um DOM a partir do HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Processar os dados extraídos da página do CGE
                const regioes = {
                    "ZONA NORTE": { regiao: "ZONA NORTE", pontos: 0, pontos_detalhes: [] },
                    "ZONA SUL": { regiao: "ZONA SUL", pontos: 0, pontos_detalhes: [] },
                    "ZONA LESTE": { regiao: "ZONA LESTE", pontos: 0, pontos_detalhes: [] },
                    "ZONA OESTE": { regiao: "ZONA OESTE", pontos: 0, pontos_detalhes: [] },
                    "CENTRO": { regiao: "CENTRO", pontos: 0, pontos_detalhes: [] },
                    "MARGINAL TIETÊ": { regiao: "MARGINAL TIETÊ", pontos: 0, pontos_detalhes: [] },
                    "MARGINAL PINHEIROS": { regiao: "MARGINAL PINHEIROS", pontos: 0, pontos_detalhes: [] }
                };
                
                // Encontrar tabelas de alagamentos
                const tables = doc.querySelectorAll('table');
                
                if (tables.length > 0) {
                    // Normalmente a tabela de alagamentos é a primeira
                    const rows = tables[0].querySelectorAll('tr');
                    
                    // Pular o cabeçalho
                    for (let i = 1; i < rows.length; i++) {
                        const cols = rows[i].querySelectorAll('td');
                        
                        if (cols.length >= 5) {
                            // Extrair informações
                            const local = cols[0].textContent.trim();
                            const subprefeitura = cols[1].textContent.trim();
                            const inicio = cols[2].textContent.trim();
                            const situacao = cols[3].textContent.trim();
                            
                            // Determinar região baseado na subprefeitura
                            let regiao = determineRegion(subprefeitura);
                            
                            // Se o local contiver "Marginal", ajustar a região
                            if (local.includes("Marginal Tietê")) {
                                regiao = "MARGINAL TIETÊ";
                            } else if (local.includes("Marginal Pinheiros")) {
                                regiao = "MARGINAL PINHEIROS";
                            }
                            
                            if (regioes[regiao]) {
                                // Determinar nível com base na situação
                                let nivel = "baixo";
                                if (situacao.includes("Intransitável")) {
                                    nivel = "intransitavel";
                                } else if (situacao.includes("Alto")) {
                                    nivel = "alto";
                                } else if (situacao.includes("Médio")) {
                                    nivel = "medio";
                                }
                                
                                // Calcular duração aproximada (aleatória para demonstração)
                                const duracao = Math.floor(Math.random() * 90) + 15; // Entre 15 e 105 minutos
                                
                                regioes[regiao].pontos++;
                                regioes[regiao].pontos_detalhes.push({
                                    endereco: local,
                                    bairro: subprefeitura,
                                    inicio: inicio,
                                    nivel: nivel,
                                    duracao: duracao,
                                    transportes: getRandomTransportInfo(nivel)
                                });
                            }
                        }
                    }
                }
                
                // Converter o objeto em array
                return Object.values(regioes);
            }
            
            // Determinar região com base na subprefeitura
            function determineRegion(subprefeitura) {
                const norte = ["Jaçanã", "Tremembé", "Santana", "Tucuruvi", "Casa Verde", "Cachoeirinha", "Vila Guilherme", "Vila Maria", "Perus", "Pirituba", "Freguesia do Ó", "Brasilândia"];
                const sul = ["Campo Limpo", "Vila Andrade", "Santo Amaro", "Campo Belo", "Jabaquara", "Cidade Ademar", "Pedreira", "Capela do Socorro", "Cidade Dutra", "Grajaú"];
                const leste = ["Mooca", "Aricanduva", "Vila Formosa", "Vila Carrão", "Penha", "Vila Matilde", "Ermelino Matarazzo", "São Miguel", "Itaim Paulista", "Itaquera", "Guaianases", "São Mateus"];
                const oeste = ["Lapa", "Vila Leopoldina", "Jaguaré", "Pinheiros", "Alto de Pinheiros", "Butantã", "Raposo Tavares", "Rio Pequeno"];
                const centro = ["Sé", "República", "Santa Cecília", "Bom Retiro", "Consolação", "Bela Vista", "Liberdade", "Cambuci"];
                
                // Verificar em qual região a subprefeitura se encaixa
                for (const sp of norte) {
                    if (subprefeitura.includes(sp)) return "ZONA NORTE";
                }
                for (const sp of sul) {
                    if (subprefeitura.includes(sp)) return "ZONA SUL";
                }
                for (const sp of leste) {
                    if (subprefeitura.includes(sp)) return "ZONA LESTE";
                }
                for (const sp of oeste) {
                    if (subprefeitura.includes(sp)) return "ZONA OESTE";
                }
                for (const sp of centro) {
                    if (subprefeitura.includes(sp)) return "CENTRO";
                }
                
                // Se não encontrou correspondência, verificar palavras-chave
                if (subprefeitura.includes("Norte")) return "ZONA NORTE";
                if (subprefeitura.includes("Sul")) return "ZONA SUL";
                if (subprefeitura.includes("Leste")) return "ZONA LESTE";
                if (subprefeitura.includes("Oeste")) return "ZONA OESTE";
                if (subprefeitura.includes("Centro")) return "CENTRO";
                
                // Padrão
                return "ZONA SUL";
            }
            
            // Gerar informações de transporte aleatórias
            function getRandomTransportInfo(nivel) {
                const transportInfos = {
                    baixo: [
                        "Trânsito lento no local",
                        "Acesso com lentidão",
                        "Linhas de ônibus operando normalmente com atrasos pontuais"
                    ],
                    medio: [
                        "Desvio por vias alternativas",
                        "Linhas de ônibus com atrasos significativos",
                        "Acesso ao metrô com dificuldade"
                    ],
                    alto: [
                        "Linhas de ônibus desviadas",
                        "Acesso ao local com grande dificuldade",
                        "CPTM operando com velocidade reduzida"
                    ],
                    intransitavel: [
                        "Acesso completamente bloqueado",
                        "Linhas de ônibus suspensas no trecho",
                        "Desvio obrigatório pelas vias adjacentes"
                    ]
                };
                
                // Escolher aleatoriamente
                const options = transportInfos[nivel];
                return options[Math.floor(Math.random() * options.length)];
            }

            // Função para atualizar estatísticas
            function updateStatistics(data) {
                // Calcular total de pontos
                const totalPontos = data.reduce((total, item) => total + item.pontos, 0);
                document.getElementById('total-pontos').textContent = totalPontos;
                
                // Calcular pontos críticos (nível alto ou intransitável)
                let pontosCriticos = 0;
                data.forEach(region => {
                    region.pontos_detalhes.forEach(ponto => {
                        if (ponto.nivel === 'alto' || ponto.nivel === 'intransitavel') {
                            pontosCriticos++;
                        }
                    });
                });
                document.getElementById('pontos-criticos').textContent = pontosCriticos;
                
                // Calcular tempo médio de duração
                let totalDuracao = 0;
                let totalPontosComDuracao = 0;
                
                data.forEach(region => {
                    region.pontos_detalhes.forEach(ponto => {
                        if (ponto.duracao) {
                            totalDuracao += ponto.duracao;
                            totalPontosComDuracao++;
                        }
                    });
                });
                
                const tempoMedio = totalPontosComDuracao > 0 ? Math.round(totalDuracao / totalPontosComDuracao) : 0;
                document.getElementById('tempo-medio').textContent = tempoMedio;
                
                // Determinar região mais afetada
                if (data.length > 0) {
                    const regiaoMaisAfetada = data.reduce((prev, current) => 
                        (prev.pontos > current.pontos) ? prev : current
                    );
                    
                    if (regiaoMaisAfetada.pontos > 0) {
                        document.getElementById('regiao-pior').textContent = regiaoMaisAfetada.regiao.split(' ')[1];
                    } else {
                        document.getElementById('regiao-pior').textContent = "Nenhuma";
                    }
                }
            }

            // Função para atualizar a tabela com os dados recebidos
            function updateTable(data) {
                const tableBody = document.getElementById('alagamentos-body');
                tableBody.innerHTML = '';
                
                // Ordenar por número de pontos (decrescente)
                data.sort((a, b) => b.pontos - a.pontos);
                
                data.forEach(item => {
                    const row = document.createElement('tr');
                    
                    // Adicionar classe CSS com base no número de pontos
                    if (item.pontos === 0) {
                        row.className = 'status-0';
                        row.dataset.status = '0';
                    } else if (item.pontos === 1) {
                        row.className = 'status-1';
                        row.dataset.status = '1';
                    } else if (item.pontos === 2) {
                        row.className = 'status-2';
                        row.dataset.status = '2';
                    } else {
                        row.className = 'status-3plus';
                        row.dataset.status = '3plus';
                    }