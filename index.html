<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento de Alagamentos - São Paulo</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f7f9fc;
            padding-top: 15px;
        }
        
        .content-wrapper {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .dashboard-header {
            background-color: #fff;
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }
        
        .dashboard-title {
            color: #3b5998;
            margin-bottom: 5px;
        }
        
        .last-update {
            color: #666;
            font-size: 0.9rem;
        }
        
        .status-card {
            border-radius: 8px;
            padding: 15px;
            height: 100%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s;
        }
        
        .status-card:hover {
            transform: translateY(-5px);
        }
        
        .status-0 {
            background-color: #e8f5e9;
        }
        
        .status-1 {
            background-color: #fff8e1;
        }
        
        .status-2 {
            background-color: #fff3e0;
        }
        
        .status-3plus {
            background-color: #ffebee;
        }
        
        .water-level {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .level-baixo {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        
        .level-medio {
            background-color: #fff8e1;
            color: #ff8f00;
            border: 1px solid #ffecb3;
        }
        
        .level-alto {
            background-color: #ffebee;
            color: #d32f2f;
            border: 1px solid #ffcdd2;
        }
        
        .level-intransitavel {
            background-color: #4a148c;
            color: white;
            border: 1px solid #6a1b9a;
        }
        
        .filter-btn {
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .stats-card {
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            height: 100%;
        }
        
        .stats-icon {
            font-size: 2rem;
            padding: 15px;
            border-radius: 50%;
            margin-bottom: 15px;
        }
        
        .stats-value {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .stats-text {
            font-size: 0.9rem;
            color: #666;
        }
        
        .region-heading {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .region-heading h5 {
            margin-bottom: 0;
        }
        
        .point-address {
            font-weight: 500;
        }
        
        .transport-info {
            margin-top: 3px;
            font-size: 0.8rem;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container-fluid content-wrapper">
        <!-- Header -->
        <div class="dashboard-header mb-4">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="dashboard-title">
                        <i class="fas fa-water text-primary me-2"></i>
                        Monitoramento de Alagamentos - São Paulo
                    </h1>
                    <p class="last-update" id="last-update">Última atualização: Carregando...</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-primary btn-sm" id="refresh-btn">
                            <i class="fas fa-sync-alt me-1"></i>Atualizar
                        </button>
                        <a href="https://www.cgesp.org/v3/alagamentos.jsp" target="_blank" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-external-link-alt me-1"></i>CGE-SP
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Estatísticas -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stats-card bg-white p-3 text-center">
                    <div class="stats-icon bg-primary text-white mx-auto">
                        <i class="fas fa-water"></i>
                    </div>
                    <div class="stats-value" id="total-points">-</div>
                    <div class="stats-text">Total de Pontos de Alagamento</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stats-card bg-white p-3 text-center">
                    <div class="stats-icon bg-danger text-white mx-auto">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stats-value" id="critical-regions">-</div>
                    <div class="stats-text">Regiões em Estado Crítico</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stats-card bg-white p-3 text-center">
                    <div class="stats-icon bg-warning text-dark mx-auto">
                        <i class="fas fa-car-crash"></i>
                    </div>
                    <div class="stats-value" id="highest-level">-</div>
                    <div class="stats-text">Pontos Intransitáveis</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stats-card bg-white p-3 text-center">
                    <div class="stats-icon bg-success text-white mx-auto">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stats-value" id="clear-regions">-</div>
                    <div class="stats-text">Regiões Sem Alagamentos</div>
                </div>
            </div>
        </div>
        
        <!-- Conteúdo Principal -->
        <div class="row">
            <!-- Tabela de Alagamentos -->
            <div class="col-md-5 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-list text-primary me-2"></i>
                                Situação por Região
                            </h5>
                            <div class="input-group input-group-sm" style="width: 180px;">
                                <input type="text" class="form-control" id="search-input" placeholder="Buscar região...">
                                <button class="btn btn-outline-secondary" type="button" id="search-btn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-secondary filter-btn active" data-filter="all">Todos</button>
                                <button type="button" class="btn btn-outline-success filter-btn" data-filter="0">Sem alagamentos</button>
                                <button type="button" class="btn btn-outline-warning filter-btn" data-filter="1">1 ponto</button>
                                <button type="button" class="btn btn-outline-warning filter-btn" data-filter="2">2 pontos</button>
                                <button type="button" class="btn btn-outline-danger filter-btn" data-filter="critical">Crítico (2+)</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Região</th>
                                        <th>Pontos</th>
                                        <th>Status</th>
                                        <th>Ação</th>
                                    </tr>
                                </thead>
                                <tbody id="alagamentos-body">
                                    <tr>
                                        <td colspan="4" class="text-center py-3">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Carregando...</span>
                                            </div>
                                            <div class="mt-2">Carregando dados...</div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Visualização detalhada -->
            <div class="col-md-7 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-map-marked-alt text-primary me-2"></i>
                            Detalhes dos Pontos de Alagamento
                        </h5>
                    </div>
                    <div class="card-body" id="regions-details-container">
                        <div id="no-details-message" class="text-center py-5">
                            <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                            <h5>Selecione uma região para ver detalhes</h5>
                            <p class="text-muted">Clique no botão "Detalhes" ao lado de uma região para ver informações sobre os pontos de alagamento.</p>
                        </div>
                        <div id="regions-details"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // API URL do CGE (Centro de Gerenciamento de Emergências)
            const API_URL = 'https://api.cgespdev.com/api/alagamentos';
            
            // Elementos da interface
            const refreshBtn = document.getElementById('refresh-btn');
            const searchBtn = document.getElementById('search-btn');
            const searchInput = document.getElementById('search-input');
            const tableBody = document.getElementById('alagamentos-body');
            const noDetailsMessage = document.getElementById('no-details-message');
            
            // Estatísticas
            const totalPointsElement = document.getElementById('total-points');
            const criticalRegionsElement = document.getElementById('critical-regions');
            const highestLevelElement = document.getElementById('highest-level');
            const clearRegionsElement = document.getElementById('clear-regions');
            
            // Event Listeners
            refreshBtn.addEventListener('click', loadData);
            searchBtn.addEventListener('click', function() {
                searchTable(searchInput.value);
            });
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    searchTable(searchInput.value);
                }
            });
            
            // Filtros de tabela
            document.querySelectorAll('.filter-btn').forEach(button => {
                button.addEventListener('click', function() {
                    // Remover classe active de todos os botões
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Adicionar classe active ao botão clicado
                    this.classList.add('active');
                    
                    // Filtrar a tabela
                    const filter = this.getAttribute('data-filter');
                    filterTable(filter);
                });
            });
            
            // Carregar dados iniciais
            loadData();
            
            // Função para carregar dados da API
            function loadData() {
                // Exibir spinner de carregamento
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <div class="mt-2">Carregando dados...</div>
                        </td>
                    </tr>
                `;
                
                // Fazer requisição à API
                fetch(API_URL)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Erro ao buscar dados');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Processar e exibir dados
                        updateTable(data);
                        updateDetailedView(data);
                        updateStatistics(data);
                        
                        // Atualizar timestamp
                        document.getElementById('last-update').textContent = 'Última atualização: ' + new Date().toLocaleString('pt-BR');
                    })
                    .catch(error => {
                        console.error('Erro:', error);
                        // Em caso de erro, usar dados de demonstração
                        useDemoData();
                    });
            }
            
            // Função para atualizar estatísticas
            function updateStatistics(data) {
                const totalPoints = data.reduce((acc, region) => acc + region.pontos, 0);
                const criticalRegions = data.filter(region => region.pontos >= 3).length;
                const intransitaveis = data.reduce((acc, region) => {
                    if (region.pontos_detalhes) {
                        return acc + region.pontos_detalhes.filter(p => p.nivel === 'intransitavel').length;
                    }
                    return acc;
                }, 0);
                const clearRegions = data.filter(region => region.pontos === 0).length;
                
                totalPointsElement.textContent = totalPoints;
                criticalRegionsElement.textContent = criticalRegions;
                highestLevelElement.textContent = intransitaveis;
                clearRegionsElement.textContent = clearRegions;
            }
            
            // Função para atualizar a tabela principal
            function updateTable(data) {
                tableBody.innerHTML = '';
                
                data.forEach(item => {
                    const row = document.createElement('tr');
                    
                    // Adicionar classes baseadas no número de pontos
                    if (item.pontos === 0) {
                        row.className = 'status-0';
                        row.dataset.status = '0';
                    } else if (item.pontos === 1) {
                        row.className = 'status-1';
                        row.dataset.status = '1';
                    } else if (item.pontos === 2) {
                        row.className = 'status-2';
                        row.dataset.status = '2';
                    } else {
                        row.className = 'status-3plus';
                        row.dataset.status = '3plus';
                    }
                    
                    // Criar colunas
                    row.innerHTML = `
                        <td><strong>${item.regiao}</strong></td>
                        <td>${item.pontos}</td>
                        <td>${getStatusText(item.pontos)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary view-details-btn" data-region="${item.regiao}">
                                <i class="fas fa-eye me-1"></i>Detalhes
                            </button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Adicionar event listeners para os botões de detalhes
                document.querySelectorAll('.view-details-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const region = this.getAttribute('data-region');
                        toggleRegionDetails(region);
                    });
                });
            }
            
            // Obter texto de status baseado no número de pontos
            function getStatusText(numPontos) {
                if (numPontos === 0) return '<span class="badge bg-success">Sem alagamentos</span>';
                if (numPontos === 1) return '<span class="badge bg-warning text-dark">1 ponto</span>';
                if (numPontos === 2) return '<span class="badge bg-warning text-dark">2 pontos</span>';
                return '<span class="badge bg-danger">Crítico - ' + numPontos + ' pontos</span>';
            }
            
            // Função para mostrar/ocultar detalhes da região
            function toggleRegionDetails(region) {
                const detailsElement = document.getElementById(`details-${region.replace(/\s+/g, '-')}`);
                
                if (detailsElement) {
                    // Se já existe, toggle
                    if (detailsElement.style.display === 'none') {
                        detailsElement.style.display = 'block';
                    } else {
                        detailsElement.style.display = 'none';
                    }
                }
            }
            
            // Função para atualizar a visão detalhada
            function updateDetailedView(data) {
                const detailsContainer = document.getElementById('regions-details');
                detailsContainer.innerHTML = '';
                
                data.forEach(item => {
                    if (item.pontos > 0) {
                        const regionDetails = document.createElement('div');
                        regionDetails.className = 'card mb-3';
                        regionDetails.id = `details-${item.regiao.replace(/\s+/g, '-')}`;
                        regionDetails.style.display = 'none';
                        
                        let detailsContent = `
                            <div class="card-header region-heading" data-region="${item.regiao}">
                                <h5>
                                    <i class="fas fa-map-marker-alt me-2 text-danger"></i>
                                    ${item.regiao} - ${item.pontos} ponto(s) de alagamento
                                </h5>
                                <button class="btn btn-sm btn-outline-secondary close-details-btn">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="card-body region-details">
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>Endereço</th>
                                                <th>Nível</th>
                                                <th>Início</th>
                                                <th>Duração</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                        `;
                        
                        item.pontos_detalhes.forEach(ponto => {
                            const nivelClass = `level-${ponto.nivel}`;
                            const nivelText = getNivelText(ponto.nivel);
                            
                            detailsContent += `
                                <tr>
                                    <td>
                                        <div class="point-address">${ponto.endereco}</div>
                                        <div class="small text-muted">${ponto.bairro}</div>
                                        <div class="transport-info">
                                            <i class="fas fa-bus me-1"></i>${ponto.transportes}
                                        </div>
                                    </td>
                                    <td><span class="water-level ${nivelClass}">${nivelText}</span></td>
                                    <td>${ponto.inicio}</td>
                                    <td>${ponto.duracao} min</td>
                                </tr>
                            `;
                        });
                        
                        detailsContent += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                        
                        regionDetails.innerHTML = detailsContent;
                        detailsContainer.appendChild(regionDetails);
                    }
                });
                
                // Adicionar event listeners para fechar detalhes
                document.querySelectorAll('.close-details-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const card = this.closest('.card');
                        card.style.display = 'none';
                    });
                });
                
                // Adicionar event listeners para cabeçalhos de região
                document.querySelectorAll('.region-heading').forEach(heading => {
                    heading.addEventListener('click', function(e) {
                        if (!e.target.closest('.close-details-btn')) {
                            const regionCard = this.closest('.card');
                            const regionBody = regionCard.querySelector('.region-details');
                            
                            if (regionBody.style.display === 'none') {
                                regionBody.style.display = 'block';
                            } else {
                                regionBody.style.display = 'none';
                            }
                        }
                    });
                });
            }
            
            // Função para converter nível em texto
            function getNivelText(nivel) {
                switch(nivel) {
                    case 'baixo': return 'Baixo';
                    case 'medio': return 'Médio';
                    case 'alto': return 'Alto';
                    case 'intransitavel': return 'Intransitável';
                    default: return 'Desconhecido';
                }
            }
            
            // Função para filtrar a tabela
            function filterTable(filter) {
                const rows = document.querySelectorAll('#alagamentos-body tr');
                
                rows.forEach(row => {
                    if (filter === 'all') {
                        row.style.display = '';
                    } else if (filter === 'critical') {
                        if (row.dataset.status === '3plus' || row.dataset.status === '2') {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    } else {
                        if (row.dataset.status === filter) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    }
                });
            }
            
            // Função para pesquisar na tabela
            function searchTable(query) {
                const rows = document.querySelectorAll('#alagamentos-body tr');
                const lowercaseQuery = query.toLowerCase();
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    if (text.includes(lowercaseQuery)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }
            
            // Função para usar dados de demonstração quan